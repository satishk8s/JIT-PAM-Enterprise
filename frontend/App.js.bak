// Global state
let currentUser = null;
let accounts = {};
let permissionSets = [];
let requests = [];
let currentTheme = 'light';
let isAdmin = false;

// Admin users list (in production, get from backend/LDAP)
const ADMIN_USERS = [
    'satish.korra@nykaa.com',
    'admin@nykaa.com',
    'security@nykaa.com'
];

// API Base URL
const API_BASE = 'http://localhost:5000/api';

// Initialize app
document.addEventListener('DOMContentLoaded', function() {
    // IMMEDIATELY remove AI assistant button if not on requests page
    setTimeout(function() {
        const currentPage = document.querySelector('.page.active');
        if (!currentPage || currentPage.id !== 'requestsPage') {
            const button = document.getElementById('unifiedAssistantButton');
            const popup = document.getElementById('unifiedAssistantPopup');
            if (button) {
                console.log('üóëÔ∏è Removing AI button on initial load (not on requests page)');
                button.remove();
            }
            if (popup) {
                console.log('üóëÔ∏è Removing AI popup on initial load');
                popup.remove();
            }
        }
    }, 100);
    
    // Check if user is logged in (in production, check JWT token)
    const isLoggedIn = localStorage.getItem('isLoggedIn');
    if (isLoggedIn === 'true') {
        showMainApp();
    }
    
    // Load theme
    const savedTheme = localStorage.getItem('theme') || 'light';
    setTheme(savedTheme);
    
    // Setup event listeners
    setupEventListeners();
});

function setupEventListeners() {
    // Username/Password form
    const usernamePasswordForm = document.getElementById('usernamePasswordForm');
    if (usernamePasswordForm) {
        usernamePasswordForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username && password) {
                // Show MFA verification
                showMFAVerification();
            }
        });
    }
    
    // Email/OTP form
    const emailOTPForm = document.getElementById('emailOTPForm');
    console.log('emailOTPForm found:', emailOTPForm);
    if (emailOTPForm) {
        emailOTPForm.addEventListener('submit', function(e) {
            console.log('Form submitted!');
            e.preventDefault();
            const email = document.getElementById('emailOTP').value;
            console.log('Email value:', email);
            
            if (email) {
                console.log('Calling showOTPVerification');
                showOTPVerification();
                alert('‚úÖ OTP sent to ' + email);
            } else {
                console.log('No email entered');
            }
        });
    } else {
        console.log('emailOTPForm NOT found');
    }
    
    // OTP Verify form
    const otpVerifyForm = document.getElementById('otpVerifyForm');
    if (otpVerifyForm) {
        otpVerifyForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const otp = document.getElementById('otp1').value +
                       document.getElementById('otp2').value +
                       document.getElementById('otp3').value +
                       document.getElementById('otp4').value +
                       document.getElementById('otp5').value +
                       document.getElementById('otp6').value;
            
            if (otp.length === 6) {
                // Simulate successful login
                const email = document.getElementById('emailOTP').value;
                isAdmin = ADMIN_USERS.includes(email.toLowerCase());
                currentUser = {
                    email: email,
                    name: email.split('@')[0],
                    isAdmin: isAdmin
                };
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('userEmail', email);
                localStorage.setItem('isAdmin', isAdmin.toString());
                localStorage.setItem('userRole', isAdmin ? 'admin' : 'user');
                showMainApp();
            }
        });
    }
    
    // MFA form
    const mfaForm = document.getElementById('mfaForm');
    if (mfaForm) {
        mfaForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const mfaCode = document.getElementById('mfaCode').value;
            
            if (mfaCode && mfaCode.length === 6) {
                // Simulate successful login
                const username = document.getElementById('username').value;
                const email = username.includes('@') ? username : username + '@nykaa.com';
                isAdmin = ADMIN_USERS.includes(email.toLowerCase());
                currentUser = {
                    email: email,
                    name: username,
                    isAdmin: isAdmin
                };
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('userEmail', email);
                localStorage.setItem('isAdmin', isAdmin.toString());
                localStorage.setItem('userRole', isAdmin ? 'admin' : 'user');
                showMainApp();
            } else {
                alert('‚ùå Invalid MFA code. Please enter 6 digits.');
            }
        });
    }
    
    // OTP input auto-focus
    setupOTPInputs();
    
    // New request form
    document.getElementById('newRequestForm').addEventListener('submit', handleNewRequest);
    
    // Close modal on overlay click
    document.getElementById('modalOverlay').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
    
    // Prevent modal from closing when clicking inside modal content
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });
    
    // Close modals with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeModal();
        }
    });
    
    // Setup form handlers after DOM loads
    setTimeout(() => {
        setupOTPInputs();
        const requestForOthersForm = document.getElementById('requestForOthersForm');
        if (requestForOthersForm) {
            requestForOthersForm.addEventListener('submit', handleRequestForOthers);
        }
        
        const manualOnboardForm = document.getElementById('manualOnboardForm');
        if (manualOnboardForm) {
            manualOnboardForm.addEventListener('submit', handleManualOnboard);
        }
        
        const appRequestForm = document.getElementById('appRequestForm');
        if (appRequestForm) {
            appRequestForm.addEventListener('submit', handleAppRequest);
            
            const appTypeSelect = document.getElementById('appType');
            if (appTypeSelect) {
                appTypeSelect.addEventListener('change', updateSpecificAppOptions);
            }
        }
    }, 100);
}

// Login Flow Functions
function showDefaultLogin() {
    document.getElementById('emailOTPView').style.display = 'block';
    document.getElementById('passwordLoginView').style.display = 'none';
    document.getElementById('otpVerifyView').style.display = 'none';
    document.getElementById('mfaView').style.display = 'none';
}

function showSSOLogin() {
    alert('Google SSO integration coming soon.\n\nYou will be redirected to Google login.');
}

function showUsernamePasswordLogin() {
    document.getElementById('emailOTPView').style.display = 'none';
    document.getElementById('passwordLoginView').style.display = 'block';
    document.getElementById('otpVerifyView').style.display = 'none';
    document.getElementById('mfaView').style.display = 'none';
}

function showOTPVerification() {
    const email = document.getElementById('emailOTP').value;
    document.getElementById('otpEmail').textContent = email;
    document.getElementById('emailOTPView').style.display = 'none';
    document.getElementById('passwordLoginView').style.display = 'none';
    document.getElementById('otpVerifyView').style.display = 'block';
    document.getElementById('mfaView').style.display = 'none';
}

function showMFAVerification() {
    document.getElementById('emailOTPView').style.display = 'none';
    document.getElementById('passwordLoginView').style.display = 'none';
    document.getElementById('otpVerifyView').style.display = 'none';
    document.getElementById('mfaView').style.display = 'block';
}

// Authentication
function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    // In production, validate with backend
    if (email && password) {
        // Check if user is admin
        isAdmin = ADMIN_USERS.includes(email.toLowerCase());
        
        currentUser = {
            email: email,
            name: 'Satish Korra',
            role: isAdmin ? 'System Administrator' : 'DevOps Engineer',
            isAdmin: isAdmin
        };
        
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('userEmail', email);
        localStorage.setItem('isAdmin', isAdmin.toString());
                localStorage.setItem('userRole', isAdmin ? 'admin' : 'user');
        showMainApp();
    }
}

function logout() {
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('userEmail');
    localStorage.removeItem('isAdmin');
    currentUser = null;
    isAdmin = false;
    const loginPage = document.getElementById('loginPage');
    const mainApp = document.getElementById('mainApp');
    if (loginPage) {
        loginPage.style.display = 'block';
        loginPage.style.visibility = 'visible';
        loginPage.classList.remove('hidden');
    }
    if (mainApp) {
        mainApp.style.display = 'none';
    }
}

function showMainApp() {
    const loginPage = document.getElementById('loginPage');
    const mainApp = document.getElementById('mainApp');
    if (loginPage) {
        loginPage.style.display = 'none';
        loginPage.classList.add('hidden');
    }
    if (mainApp) {
        mainApp.style.display = 'block';
    }
    
    // Load admin status from storage
    isAdmin = localStorage.getItem('isAdmin') === 'true';
    
    // Set current user from storage
    const userEmail = localStorage.getItem('userEmail');
    if (userEmail) {
        currentUser = {
            email: userEmail,
            name: userEmail.split('@')[0],
            isAdmin: isAdmin
        };
    }
    
    // Update UI based on admin status
    updateUIForRole();
    
    // Load initial data
    loadAccounts();
    loadPermissionSets();
    loadRequests();
    updateDashboard();
    
    // Load policy settings for admin toggles
    if (isAdmin && typeof loadPolicySettings === 'function') {
        loadPolicySettings();
    }
}

function updateUIForRole() {
    const userName = document.getElementById('userName');
    if (userName && currentUser) {
        userName.textContent = isAdmin ? `üëë ${currentUser.name} (Admin)` : currentUser.name;
    }
    
    // CRITICAL: FORCE ADMIN PANEL TO ALWAYS BE VISIBLE
    const adminNavItem = document.getElementById('adminNavItem');
    if (adminNavItem) {
        adminNavItem.style.setProperty('display', 'flex', 'important');
        adminNavItem.style.visibility = 'visible';
        adminNavItem.style.opacity = '1';
        console.log('‚úÖ Admin Panel forced visible in updateUIForRole');
    }
    
    // Also force on page load
    setTimeout(() => {
        const adminNav = document.getElementById('adminNavItem');
        if (adminNav) {
            adminNav.style.setProperty('display', 'flex', 'important');
            adminNav.style.visibility = 'visible';
            adminNav.style.opacity = '1';
        }
    }, 100);
    
    // Add admin navigation if admin (legacy support)
    if (isAdmin) {
        addAdminNavigation();
    }
}

function addAdminNavigation() {
    const nav = document.querySelector('.app-nav');
    if (nav && !document.getElementById('adminNav')) {
        const adminBtn = document.createElement('button');
        adminBtn.id = 'adminNav';
        adminBtn.className = 'nav-btn';
        adminBtn.innerHTML = '<i class="fas fa-shield-alt"></i> Admin Panel';
        adminBtn.onclick = () => showPage('admin');
        nav.appendChild(adminBtn);
    }
}

// Theme Management
function toggleTheme() {
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
}

function setTheme(theme) {
    currentTheme = theme;
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    
    // Update theme buttons
    document.querySelectorAll('.theme-option').forEach(btn => {
        btn.classList.remove('active');
        if (btn.onclick.toString().includes(theme)) {
            btn.classList.add('active');
        }
    });
    
    // Update theme toggle icon in profile menu
    const themeIcon = document.getElementById('themeIcon');
    const themeText = document.getElementById('themeText');
    if (themeIcon) {
        themeIcon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
    }
    if (themeText) {
        themeText.textContent = theme === 'light' ? 'Switch to Dark' : 'Switch to Light';
    }
    
    // Update theme toggle icon in top bar if exists
    const topBarThemeIcon = document.querySelector('.theme-toggle i');
    if (topBarThemeIcon) {
        topBarThemeIcon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
    }
}

// Navigation
function showPage(pageId) {
    // Reset wizard state when navigating away from requests page
    const currentPage = document.querySelector('.page.active');
    if (currentPage && currentPage.id === 'requestsPage' && pageId !== 'requests') {
        if (typeof resetWizardOnNavigation === 'function') {
            resetWizardOnNavigation();
        }
    }
    
    // Hide all pages
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    
    // Show selected page
    const targetPage = document.getElementById(pageId + 'Page');
    if (!targetPage) {
        console.error('‚ùå Page not found:', pageId + 'Page');
        alert('Page not found: ' + pageId + '. Please check the page ID.');
        return;
    }
    targetPage.classList.add('active');
    console.log('‚úÖ Showing page:', pageId, targetPage.id);
    
    // Update sidebar nav items
    document.querySelectorAll('.sidebar-nav .nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Find and activate the clicked nav item by pageId
    const clickedNavItem = document.querySelector(`.nav-item[onclick*="showPage('${pageId}')"]`);
    if (clickedNavItem) {
        clickedNavItem.classList.add('active');
    } else if (typeof event !== 'undefined' && event && event.target) {
        const navItem = event.target.closest('.nav-item');
        if (navItem) {
            navItem.classList.add('active');
        }
    }
    
    // Hide/show unified assistant button based on page
    // ONLY show on requests page, hide everywhere else
    const unifiedButton = document.getElementById('unifiedAssistantButton');
    const unifiedPopup = document.getElementById('unifiedAssistantPopup');
    
    console.log('üîç showPage - pageId:', pageId, 'button exists:', !!unifiedButton);
    
    if (pageId === 'requests') {
        // Show ONLY on requests page with !important
        console.log('‚úÖ On requests page, showing button');
        if (unifiedButton) {
            unifiedButton.style.setProperty('display', 'flex', 'important');
        }
        // Re-initialize unified assistant when switching to requests page
        if (typeof initUnifiedAssistant === 'function') {
            setTimeout(() => {
                initUnifiedAssistant();
            }, 100);
        }
    } else {
        // REMOVE button completely from DOM if not on requests page
        console.log('‚ùå Not on requests page, removing button');
        if (unifiedButton) {
            unifiedButton.remove();
            console.log('‚úÖ Button removed');
        }
        if (unifiedPopup) {
            unifiedPopup.remove();
            console.log('‚úÖ Popup removed');
        }
    }
    
    // Load page-specific data
    if (pageId === 'accounts') {
        loadAccountsPage();
    } else if (pageId === 'requests') {
        // Always start fresh on requests page
        if (typeof clearWizardState === 'function') {
            clearWizardState();
        }
        loadRequestsPage();
    } else if (pageId === 'applications') {
        loadApplicationsPage();
    } else if (pageId === 'admin') {
        loadAdminPage();
    } else if (pageId === 'instances') {
        loadInstances();
    } else if (pageId === 'terminal') {
        console.log('Loading terminal page...');
        if (typeof refreshApprovedInstances === 'function') {
            refreshApprovedInstances();
        } else {
            console.error('refreshApprovedInstances function not found');
        }
    } else if (pageId === 's3') {
        loadS3Buckets();
    } else if (pageId === 'dashboard') {
        updateDashboard();
    }
}

// Admin Tab Navigation
function showAdminTab(tabId) {
    // Hide ALL admin tabs first
    document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
        tab.style.display = 'none';
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.admin-tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Map tab IDs
    const tabMap = {
        'dashboard': 'adminDashboardTab',
        'users': 'adminUsersTab',
        'policies': 'adminPoliciesTab',
        'security': 'adminSecurityTab',
        'workflows': 'adminWorkflowsTab',
        'integrations': 'adminIntegrationsTab'
    };
    
    // Show ONLY selected tab
    const targetTab = document.getElementById(tabMap[tabId]);
    if (targetTab) {
        targetTab.classList.add('active');
        targetTab.style.display = 'block';
        targetTab.style.visibility = 'visible';
        
        // Activate corresponding button
        const buttons = document.querySelectorAll('.admin-tab-btn');
        buttons.forEach(btn => {
            if (btn.onclick && btn.onclick.toString().includes(tabId)) {
                btn.classList.add('active');
            }
        });
        
        // Initialize flow builder if workflows tab
        if (tabId === 'workflows') {
            setTimeout(() => {
                if (typeof initFlowBuilder === 'function') {
                    initFlowBuilder();
                }
            }, 100);
        }
        
        // Load guardrails if security tab
        if (tabId === 'security') {
            setTimeout(() => {
                if (typeof loadGuardrails === 'function') {
                    loadGuardrails();
                }
            }, 100);
        }
    }
}
            setTimeout(() => {
                if (typeof initFlowBuilder === 'function') {
                    initFlowBuilder();
                }
            }, 100);
        }
        
        // Force show security sub-tab if security tab
        if (tabId === 'security') {
            setTimeout(() => {
                if (typeof showSecuritySubTab === 'function') {
                    showSecuritySubTab('security');
                }
            }, 100);
        }
    }
    
    // Update tab buttons
    document.querySelectorAll('.admin-tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    if (event && event.target) {
        event.target.classList.add('active');
    }
    
    // Load tab-specific data
    if (tabId === 'dashboard') {
        loadAdminDashboard();
    // } else if (tabId === 'scps') {  // Commented out - not required
    //     loadSCPs();
    } else if (tabId === 'users') {
        loadUsersManagement();
    } else if (tabId === 'policies') {
        if (typeof initPolicyConfig === 'function') initPolicyConfig();
        // Always reload policy settings when showing policies tab
        setTimeout(() => {
            if (typeof loadPolicySettings === 'function') loadPolicySettings();
        }, 100);
        if (typeof loadAccountsForTagging === 'function') loadAccountsForTagging();
        // Load organization groups and users
        if (typeof loadOrgGroups === 'function') loadOrgGroups();
        if (typeof loadOrgUsers === 'function') loadOrgUsers();
    } else if (tabId === 'features') {
        // Features tab - already rendered
    } else if (tabId === 'security') {
        // Ensure security section is visible by default
        setTimeout(() => {
            const secSection = document.getElementById('securitySection');
            if (secSection) secSection.style.display = 'block';
            const guarSection = document.getElementById('guardrailsSection');
            if (guarSection) guarSection.style.display = 'none';
            const auditSection = document.getElementById('auditSection');
            if (auditSection) auditSection.style.display = 'none';
        }, 10);
        loadAuditLogs();
    }
}

// Profile Menu
function toggleProfileMenu() {
    const menu = document.getElementById('profileMenu');
    menu.classList.toggle('show');
}

// Close profile menu when clicking outside
document.addEventListener('click', function(e) {
    const profileDropdown = document.querySelector('.profile-dropdown');
    if (!profileDropdown.contains(e.target)) {
        document.getElementById('profileMenu').classList.remove('show');
    }
});

// Modal Management
function showModal(modalId) {
    document.getElementById('modalOverlay').classList.add('show');
    document.getElementById(modalId).classList.add('show');
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('show');
    document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.remove('show');
    });
}

function showNewRequestPage() {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('newRequestPage').classList.add('active');
    loadRequestModalData();
}

function cancelNewRequest() {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('requestsPage').classList.add('active');
    document.getElementById('newRequestForm').reset();
    document.getElementById('resourcesGroup').style.display = 'none';
    document.getElementById('aiPermissionsPreview').style.display = 'none';
    window.currentAIPermissions = null;
    selectedResources = [];
    selectedService = '';
    // Hide AWS Permissions Chat
    if (typeof hideAWSPermChatButton === 'function') hideAWSPermChatButton();
    if (typeof resetAWSPermChat === 'function') resetAWSPermChat();
}

function showRequestForOthersModal() {
    const page = document.getElementById('requestForOthersPage');
    if (!page) {
        alert('ERROR: requestForOthersPage not found!');
        return;
    }
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    page.classList.add('active');
    document.getElementById('othersStep1').style.display = 'block';
    document.getElementById('othersStep2AWS').style.display = 'none';
    if (typeof loadAccountsForOthers === 'function') loadAccountsForOthers();
}

function cancelRequestForOthers() {
    showPage('requests');
    document.getElementById('othersStep1').style.display = 'block';
    document.getElementById('othersStep2AWS').style.display = 'none';
}

function closeRequestForOthersModal() {
    cancelRequestForOthers();
    // Clear form
    document.getElementById('requestForOthersForm').reset();
    selectedEmails = [];
    renderEmailTags();
    otherCurrentAIPermissions = null;
    const preview = document.getElementById('otherAiPermissionsPreview');
    if (preview) preview.style.display = 'none';
}

function showManualOnboardModal() {
    showModal('manualOnboardModal');
}

function showNewAppRequestModal() {
    showModal('appRequestModal');
}

// Applications Page Functions
function loadApplicationsPage() {
    console.log('Applications page loaded');
}

function requestCloudAccess(provider) {
    alert(`Cloud access request for ${provider.toUpperCase()} will be available in future releases.`);
}

function requestK8sAccess(cluster) {
    alert(`Kubernetes access request for ${cluster.toUpperCase()} will be available in future releases.`);
}

function requestGkeAccess() {
    alert('Google GKE access request will be available in future releases.');
}

function requestDbAccess(database) {
    alert(`Database access request for ${database} will be available in future releases.`);
}

function requestAppAccess(app) {
    alert(`Application access request for ${app} will be available in future releases.`);
}

function showProfile() {
    showModal('profileModal');
}

// Dummy functions for future implementation
function showResetPassword() {
    alert('Password reset functionality will be integrated with your IGA tool');
}

function showMFAReset() {
    alert('MFA reset functionality will be integrated with your IGA tool');
}

function showManager() {
    alert('Manager information will be loaded from your HR system');
}

function showPasswordReset() {
    alert('Password reset functionality will be integrated with your IGA tool');
}

// Data Loading Functions
async function loadAccounts() {
    try {
        const response = await fetch(`${API_BASE}/accounts`);
        accounts = await response.json();
        console.log('Loaded accounts:', Object.keys(accounts).length);
    } catch (error) {
        console.error('Error loading accounts:', error);
        // Fallback data
        accounts = {
            '332463837037': { id: '332463837037', name: 'Nykaa-fashion' }
        };
    }
}

async function loadPermissionSets() {
    try {
        const response = await fetch(`${API_BASE}/permission-sets`);
        permissionSets = await response.json();
        console.log('Loaded permission sets:', permissionSets.length);
    } catch (error) {
        console.error('Error loading permission sets:', error);
        // Fallback data
        permissionSets = [
            { name: 'ReadOnlyAccess', arn: 'arn:aws:iam::aws:policy/ReadOnlyAccess' },
            { name: 'PowerUserAccess', arn: 'arn:aws:iam::aws:policy/PowerUserAccess' }
        ];
    }
}

async function loadRequests() {
    try {
        const response = await fetch(`${API_BASE}/requests`);
        requests = await response.json();
        console.log('Loaded requests:', requests.length);
    } catch (error) {
        console.error('Error loading requests:', error);
        requests = [];
    }
}

// Dashboard Functions
function updateDashboard() {
    // Update KPI counts using new helper function
    if (typeof updateDashboardKPIs === 'function') {
        updateDashboardKPIs();
    }
    
    // Update recent JIT requests
    if (typeof loadRecentJITRequests === 'function') {
        loadRecentJITRequests();
    }
    
    // Legacy support for old dashboard elements
    const activeAccess = requests.filter(r => r.status === 'approved' && new Date(r.expires_at) > new Date()).length;
    const pendingRequests = requests.filter(r => r.status === 'pending').length;
    const approvedThisMonth = requests.filter(r => {
        const requestDate = new Date(r.created_at);
        const now = new Date();
        return r.status === 'approved' && 
               requestDate.getMonth() === now.getMonth() && 
               requestDate.getFullYear() === now.getFullYear();
    }).length;
    
    const activeAccessEl = document.getElementById('activeAccessCount');
    const pendingRequestsEl = document.getElementById('pendingRequestsCount');
    const approvedRequestsEl = document.getElementById('approvedRequestsCount');
    
    if (activeAccessEl) activeAccessEl.textContent = activeAccess;
    if (pendingRequestsEl) pendingRequestsEl.textContent = pendingRequests;
    if (approvedRequestsEl) approvedRequestsEl.textContent = approvedThisMonth;
    
    updateRecentActivity();
}

function updateRecentActivity() {
    const recentActivity = document.getElementById('recentActivity');
    const sortedRequests = requests.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 5);
    
    if (sortedRequests.length === 0) {
        recentActivity.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No recent activity</p>';
        return;
    }
    
    recentActivity.innerHTML = sortedRequests.map(request => {
        const account = accounts[request.account_id];
        const iconClass = request.status === 'approved' ? 'success' : 
                         request.status === 'denied' ? 'danger' : 'warning';
        const icon = request.status === 'approved' ? 'check' : 
                    request.status === 'denied' ? 'times' : 'clock';
        
        return `
            <div class="activity-item">
                <div class="activity-icon ${iconClass}">
                    <i class="fas fa-${icon}"></i>
                </div>
                <div class="activity-content">
                    <p><strong>Access request ${request.status}</strong></p>
                    <p>${account ? account.name : 'Unknown Account'} - ${request.permission_set}</p>
                    <small>${formatDate(request.created_at)}</small>
                </div>
            </div>
        `;
    }).join('');
}

// Requests Page Functions
let currentFilter = 'all';

function filterRequests(filter) {
    currentFilter = filter;
    
    // Update status tabs
    document.querySelectorAll('.status-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.getAttribute('data-filter') === filter) {
            tab.classList.add('active');
        }
    });
    
    loadRequestsPage();
    // Update counts after a short delay to ensure requests are loaded
    setTimeout(() => {
        if (typeof updateRequestCounts === 'function') {
            updateRequestCounts();
        }
    }, 100);
}

function loadRequestsPage() {
    const grid = document.getElementById('requestsGrid');
    if (!grid) {
        // Grid might not exist if chat is showing - show list container
        const listContainer = document.getElementById('requestsListContainer');
        const chatContainer = document.querySelector('.requests-chat-container');
        if (listContainer && chatContainer) {
            listContainer.style.display = 'block';
            chatContainer.style.display = 'none';
            // Try again after showing container
            setTimeout(() => {
                const grid2 = document.getElementById('requestsGrid');
                if (grid2) loadRequestsPage();
            }, 100);
        }
        return;
    }
    
    let filteredRequests = requests;
    
    // Filter by status
    if (currentFilter === 'ongoing') {
        filteredRequests = requests.filter(r => r.status === 'approved' && new Date(r.expires_at) > new Date());
    } else if (currentFilter !== 'all') {
        filteredRequests = requests.filter(r => r.status === currentFilter);
    }
    
    if (filteredRequests.length === 0) {
        grid.innerHTML = '<div style="text-align: center; padding: 3rem; color: var(--text-secondary);">No requests found</div>';
        return;
    }
    
    // Use new JIT request card if helper function is available
    if (typeof createJITRequestCard === 'function') {
        grid.innerHTML = filteredRequests.map(request => {
            const account = accounts[request.account_id];
            return createJITRequestCard(request, account);
        }).join('');
    } else {
        // Fallback to old card format
        grid.innerHTML = filteredRequests.map(request => {
            const account = accounts[request.account_id];
            const statusClass = `status-${request.status}`;
            
            return `
                <div class="request-card">
                    <div class="request-header">
                        <div class="request-title">
                            <div class="request-id">#${request.id.substring(0, 8)}</div>
                            <div class="request-account">${account ? account.name : 'Unknown Account'}</div>
                        </div>
                        <span class="status-badge ${statusClass}">${request.status}</span>
                    </div>
                    
                    <div class="request-details">
                        <div class="detail-item">
                            <div class="detail-label">Access Type</div>
                            <div class="detail-value">${request.ai_generated ? 'AI Generated' : request.permission_set}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Requested</div>
                            <div class="detail-value">${formatDate(request.created_at)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Expires</div>
                            <div class="detail-value">${formatDate(request.expires_at)}</div>
                        </div>
                    </div>
                    
                    <div class="request-actions">
                        <button class="action-btn action-btn-secondary" onclick="viewRequest('${request.id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                        ${request.status === 'pending' ? `
                        <button class="action-btn action-btn-secondary" onclick="modifyRequest('${request.id}')">
                            <i class="fas fa-edit"></i> Modify
                        </button>
                        <button class="action-btn action-btn-primary" onclick="approveRequest('${request.id}')">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        ` : ''}
                        ${request.status === 'approved' ? `
                        <button class="action-btn action-btn-danger" onclick="revokeAccess('${request.id}')">
                            <i class="fas fa-ban"></i> Revoke
                        </button>
                        ` : ''}
                        <button class="action-btn action-btn-danger" onclick="deleteRequest('${request.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }
}

async function viewRequest(requestId) {
    try {
        const response = await fetch(`${API_BASE}/request/${requestId}`);
        const request = await response.json();
        
        let details = `Request Details:\n\nID: ${request.id}\nStatus: ${request.status.toUpperCase()}\nAccount: ${accounts[request.account_id]?.name || 'Unknown'}\nDuration: ${request.duration_hours} hours\nJustification: ${request.justification}\n\n`;
        
        if (request.ai_generated && request.ai_permissions) {
            // Show SEPARATE statements per service
            const statements = [];
            if (request.ai_permissions.grouped_actions) {
                for (const [service, data] of Object.entries(request.ai_permissions.grouped_actions)) {
                    statements.push({
                        "Sid": service.toUpperCase().replace('-', ''),
                        "Effect": "Allow",
                        "Action": data.actions,
                        "Resource": data.resources
                    });
                }
            } else {
                statements.push({
                    "Effect": "Allow",
                    "Action": request.ai_permissions.actions || [],
                    "Resource": request.ai_permissions.resources || ['*']
                });
            }
            
            const policy = {
                "Version": "2012-10-17",
                "Statement": statements
            };
            
            details += `AWS IAM Policy (This gets created in AWS):\n${JSON.stringify(policy, null, 2)}\n\n`;
            
            if (request.service_configs) {
                details += `Service Configurations:\n${JSON.stringify(request.service_configs, null, 2)}\n`;
            }
        } else {
            details += `Permission Set: ${request.permission_set}\n`;
        }
        
        if (request.permission_set_name) {
            details += `\nCreated Permission Set: ${request.permission_set_name}`;
        }
        
        // Show in console for full view
        console.log('=== FULL REQUEST DETAILS ===');
        console.log('Request:', request);
        if (request.ai_generated && request.ai_permissions) {
            const policy = {
                "Version": "2012-10-17",
                "Statement": [{
                    "Effect": "Allow",
                    "Action": request.ai_permissions.actions,
                    "Resource": request.ai_permissions.resources
                }]
            };
            if (request.ai_permissions.conditions) {
                policy.Statement[0].Condition = request.ai_permissions.conditions;
            }
            console.log('=== EXACT AWS POLICY ===');
            console.log(JSON.stringify(policy, null, 2));
        }
        console.log('=== END DETAILS ===');
        
        let policy = 'No policy data';
        if (request.ai_permissions) {
            const statements = [];
            if (request.ai_permissions.grouped_actions) {
                for (const [service, data] of Object.entries(request.ai_permissions.grouped_actions)) {
                    statements.push({
                        "Sid": service.toUpperCase().replace('-', ''),
                        "Effect": "Allow",
                        "Action": data.actions,
                        "Resource": data.resources
                    });
                }
            } else {
                statements.push({
                    "Effect": "Allow",
                    "Action": request.ai_permissions.actions || [],
                    "Resource": request.ai_permissions.resources || ['*']
                });
            }
            policy = JSON.stringify({
                "Version": "2012-10-17",
                "Statement": statements
            }, null, 2);
        }
        
        const modalHtml = `<div class="policy-modal-overlay" onclick="this.remove()" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;"><div class="policy-modal-content" onclick="event.stopPropagation()" style="background: var(--bg-primary); color: var(--text-primary); padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: var(--shadow);"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;"><h3 style="color: var(--text-primary); margin: 0;">AWS IAM Policy</h3><button onclick="this.closest('.policy-modal-overlay').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); padding: 4px;">&times;</button></div><pre style="background: var(--bg-secondary); color: var(--text-primary); padding: 1rem; overflow-x: auto; font-size: 12px; border-radius: 4px; border: 1px solid var(--border-color);">${policy}</pre><div style="margin-top: 1rem; text-align: right;"><button onclick="this.closest('.policy-modal-overlay').remove()" style="padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button></div></div></div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    } catch (error) {
        console.error('Error viewing request:', error);
        alert('Error loading request details');
    }
}

function modifyRequest(requestId) {
    const additionalPermissions = prompt('Enter additional permissions (comma-separated):\n\nExample: s3:PutObject, lambda:InvokeFunction');
    
    if (!additionalPermissions) return;
    
    const permissions = additionalPermissions.split(',').map(p => p.trim());
    
    fetch(`${API_BASE}/request/${requestId}/modify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ additional_permissions: permissions })
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            alert('Error: ' + result.error);
        } else {
            alert('‚úÖ Request modified successfully! Approvals have been reset.');
            loadRequests();
            updateDashboard();
        }
    })
    .catch(error => {
        console.error('Error modifying request:', error);
        alert('Error modifying request');
    });
}

function approveRequest(requestId) {
    if (!confirm('Are you sure you want to approve this request?')) return;
    
    fetch(`${API_BASE}/approve/${requestId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ approver_role: 'self' })
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            alert('Error: ' + result.error);
        } else {
            const request = requests.find(r => r.id === requestId);
            const isInstanceAccess = request && request.type === 'instance_access';
            
            if (isInstanceAccess) {
                alert(`‚úÖ ${result.message}\n\nGo to Instances page to connect.`);
            } else {
                alert(`‚úÖ ${result.message}`);
            }
            
            loadRequests();
            updateDashboard();
            
            // Refresh approved instances if function exists
            if (typeof refreshApprovedInstances === 'function') {
                refreshApprovedInstances();
            }
        }
    })
    .catch(error => {
        console.error('Error approving request:', error);
        alert('Error approving request');
    });
}

function revokeAccess(requestId) {
    const reason = prompt('‚ö†Ô∏è ADMIN REVOKE\n\nEnter reason for revoking access (required):');
    
    if (!reason) {
        alert('Revocation reason is required');
        return;
    }
    
    if (!confirm(`‚ùå Are you sure you want to REVOKE access?\n\nThis will immediately remove AWS permissions and delete the permission set.\n\nReason: ${reason}`)) {
        return;
    }
    
    fetch(`${API_BASE}/request/${requestId}/revoke`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason: reason })
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            alert('‚ùå Revocation Error: ' + result.error);
        } else {
            alert(`‚ùå ${result.message}`);
            loadRequests();
            updateDashboard();
        }
    })
    .catch(error => {
        console.error('Error revoking access:', error);
        alert('‚ùå Error revoking access');
    });
}

function deleteRequest(requestId) {
    if (!confirm('‚ö†Ô∏è ADMIN DELETE\n\nAre you sure you want to DELETE this request?\n\nThis action cannot be undone and will permanently remove the request from the system.')) {
        return;
    }
    
    fetch(`${API_BASE}/request/${requestId}/delete`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            alert('‚ùå Delete Error: ' + result.error);
        } else {
            alert(`‚úÖ ${result.message}`);
            loadRequests();
            updateDashboard();
        }
    })
    .catch(error => {
        console.error('Error deleting request:', error);
        alert('‚ùå Error deleting request');
    });
}

function toggleCloudProvider(provider) {
    // Navigate to dedicated cloud provider detail page instead of inline expansion
    showCloudProviderDetail(provider);
}

function showCloudProviderDetail(provider) {
    // Hide accounts page
    const accountsPage = document.getElementById('accountsPage');
    if (accountsPage) accountsPage.classList.remove('active');
    
    // Create or show detail page
    let detailPage = document.getElementById('cloudProviderDetailPage');
    if (!detailPage) {
        detailPage = document.createElement('div');
        detailPage.id = 'cloudProviderDetailPage';
        detailPage.className = 'page';
        document.querySelector('.app-main').appendChild(detailPage);
    }
    
    detailPage.classList.add('active');
    
    const providerNames = {
        'aws': 'AWS Accounts',
        'gcp': 'GCP Projects',
        'azure': 'Azure Subscriptions',
        'oracle': 'Oracle Compartments'
    };
    
    const providerIcons = {
        'aws': 'fab fa-aws',
        'gcp': 'fab fa-google',
        'azure': 'fab fa-microsoft',
        'oracle': 'fas fa-cloud'
    };
    
    detailPage.innerHTML = `
        <div class="page-header">
            <button class="btn-secondary" onclick="backToAccounts()" style="margin-right: 15px;">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <h2><i class="${providerIcons[provider]}"></i> ${providerNames[provider]}</h2>
        </div>
        <div id="providerAccountsGrid" class="accounts-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px;">
            <p style="color: var(--text-secondary); text-align: center; padding: 40px;">Loading...</p>
        </div>
    `;
    
    // Load accounts
    if (provider === 'aws') {
        loadAwsAccountsInDetail();
    } else {
        document.getElementById('providerAccountsGrid').innerHTML = `
            <div style="text-align: center; padding: 60px; color: var(--text-secondary);">
                <i class="${providerIcons[provider]}" style="font-size: 64px; opacity: 0.3; margin-bottom: 20px; display: block;"></i>
                <h3>${providerNames[provider]} integration coming soon</h3>
            </div>
        `;
    }
}

function backToAccounts() {
    const detailPage = document.getElementById('cloudProviderDetailPage');
    if (detailPage) detailPage.classList.remove('active');
    
    const accountsPage = document.getElementById('accountsPage');
    if (accountsPage) accountsPage.classList.add('active');
}

function loadAwsAccountsInDetail() {
    const grid = document.getElementById('providerAccountsGrid');
    
    if (Object.keys(accounts).length === 0) {
        grid.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No accounts found</p>';
        return;
    }
    
    grid.innerHTML = Object.entries(accounts).map(([accountId, accountData]) => `
        <div class="account-card" style="background: var(--bg-secondary); border: 1.5px solid var(--border-color); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--primary-color)'" onmouseout="this.style.borderColor='var(--border-color)'" onclick="showAccountDetail('${accountId}')">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                <i class="fab fa-aws" style="font-size: 32px; color: #FF9900;"></i>
                <div>
                    <h4 style="margin: 0; color: var(--text-primary); font-size: 16px;">${accountData.name || accountId}</h4>
                    <p style="margin: 0; color: var(--text-secondary); font-size: 12px;">${accountId}</p>
                </div>
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <span class="badge badge-${accountData.environment === 'production' ? 'danger' : 'info'}" style="font-size: 11px;">${accountData.environment || 'NON-PROD'}</span>
                <span class="badge badge-success" style="font-size: 11px;">Active</span>
            </div>
        </div>
    `).join('');
}

function showAccountDetail(accountId) {
    alert(`Account detail page for ${accountId} - Coming soon!\n\nThis will show:\n- Resources\n- Permissions\n- Access history\n- Request access button`);
}

function loadAwsAccounts() {
    const grid = document.getElementById('awsAccountsGrid');
    
    if (Object.keys(accounts).length === 0) {
        grid.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No accounts found</p>';
        return;
    }
    
    grid.innerHTML = `
        <table>
            <thead>
                <tr>
                    <th>Account Name</th>
                    <th>Account ID</th>
                    <th>Region</th>
                </tr>
            </thead>
            <tbody>
                ${Object.values(accounts).map(account => `
                    <tr>
                        <td><strong>${account.name}</strong></td>
                        <td>${account.id}</td>
                        <td>ap-south-1</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

// Accounts Page Functions
function loadAccountsPage() {
    const grid = document.getElementById('accountsGrid');
    
    if (Object.keys(accounts).length === 0) {
        grid.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No accounts found</p>';
        return;
    }
    
    grid.innerHTML = Object.values(accounts).map(account => `
        <div class="account-card">
            <div class="account-header">
                <h3>${account.name}</h3>
            </div>
            <p><strong>Account ID:</strong> ${account.id}</p>
            <div style="margin-top: 1rem;">
                <button class="btn-primary" onclick="requestAccessForAccount('${account.id}')">
                    <i class="fas fa-plus"></i> Request Access
                </button>
            </div>
        </div>
    `).join('');
}

function requestAccessForAccount(accountId) {
    // Pre-select the account in the modal
    loadRequestModalData();
    document.getElementById('requestAccount').value = accountId;
    showModal('newRequestModal');
}

// Request Modal Functions
function loadRequestModalData() {
    // Load accounts
    const accountSelect = document.getElementById('requestAccount');
    accountSelect.innerHTML = '<option value="">Select Account</option>' +
        Object.values(accounts).map(account => 
            `<option value="${account.id}">${account.name} (${account.id})</option>`
        ).join('');
    
    // Load permission sets
    const permissionSetSelect = document.getElementById('requestPermissionSet');
    permissionSetSelect.innerHTML = '<option value="">Select Permission Set</option>' +
        permissionSets.map(ps => 
            `<option value="${ps.arn}">${ps.name}</option>`
        ).join('');
    
    // Setup duration change handler
    const durationSelect = document.getElementById('requestDuration');
    if (durationSelect) {
        durationSelect.onchange = function() {
            if (this.value === 'custom') {
                showDateModal();
            }
        };
    }
    
    // Setup AWS services change handler
    const servicesSelect = document.getElementById('awsServices');
    if (servicesSelect) {
        servicesSelect.addEventListener('change', function() {
            updateServiceConfigs();
        });
    }
    
    // Set default date/time values
    const now = new Date();
    const startTime = new Date(now.getTime() + 5 * 60000); // 5 minutes from now
    const endTime = new Date(startTime.getTime() + 8 * 60 * 60 * 1000); // 8 hours later
    
    const startEl = document.getElementById('startDateTime');
    const endEl = document.getElementById('endDateTime');
    if (startEl) startEl.value = formatDateTimeLocal(startTime);
    if (endEl) endEl.value = formatDateTimeLocal(endTime);
}

let startCalendar, endCalendar;

function showDateModal() {
    const modal = document.getElementById('dateRangeModal');
    if (modal) {
        modal.style.display = 'block';
        
        if (!startCalendar) {
            const startInput = document.getElementById('startDateTime');
            const endInput = document.getElementById('endDateTime');
            if (startInput && endInput) {
                startCalendar = new CalendarPopup(startInput);
                endCalendar = new CalendarPopup(endInput);
            }
        }
    }
}

function closeDateModal() {
    const modal = document.getElementById('dateRangeModal');
    if (modal) {
        modal.style.display = 'none';
    }
    document.getElementById('requestDuration').value = '8';
}

function formatDateTimeLocal(date) {
    if (!(date instanceof Date) || isNaN(date.getTime())) {
        return '';
    }
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}

function applyCustomDates() {
    const startValue = document.getElementById('startDateTime').value;
    const endValue = document.getElementById('endDateTime').value;
    
    if (!startValue || !endValue) {
        alert('Please select both start and end dates');
        return;
    }
    
    // Parse calendar format: YYYY-MM-DD HH:mm AM/PM
    const parseDateTime = (str) => {
        const parts = str.match(/(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}) (AM|PM)/);
        if (!parts) return null;
        
        let hours = parseInt(parts[4]);
        const minutes = parseInt(parts[5]);
        const ampm = parts[6];
        
        if (ampm === 'PM' && hours !== 12) hours += 12;
        if (ampm === 'AM' && hours === 12) hours = 0;
        
        return new Date(parts[1], parts[2] - 1, parts[3], hours, minutes);
    };
    
    const startDate = parseDateTime(startValue);
    const endDate = parseDateTime(endValue);
    
    if (!startDate || !endDate) {
        alert('Invalid date format');
        return;
    }
    
    const now = new Date();
    
    if (endDate <= startDate) {
        alert('End date must be after start date');
        return;
    }
    
    const durationMs = endDate.getTime() - startDate.getTime();
    const durationHours = Math.round(durationMs / (1000 * 60 * 60));
    const maxHours = 5 * 24;
    
    if (durationHours > maxHours) {
        alert(`Maximum duration is 5 days (120 hours). Selected duration: ${durationHours} hours`);
        return;
    }
    
    const durationSelect = document.getElementById('requestDuration');
    const customOption = durationSelect.querySelector('option[value="custom"]');
    customOption.textContent = `Custom (${durationHours}h)`;
    
    window.customDuration = {
        hours: durationHours,
        startDate: startDate.toISOString(),
        endDate: endDate.toISOString()
    };
    
    alert(`‚úÖ Custom dates set: ${durationHours} hours\nFrom: ${startDate.toLocaleString()}\nTo: ${endDate.toLocaleString()}`);
    
    closeDateModal();
}



function updateServiceConfigs() {
    const servicesSelect = document.getElementById('awsServices');
    const configsContainer = document.getElementById('serviceConfigs');
    
    if (!servicesSelect || !configsContainer) return;
    
    const selectedServices = Array.from(servicesSelect.selectedOptions).map(option => option.value);
    
    // Clear existing configs
    configsContainer.innerHTML = '';
    
    // Service configuration templates
    const serviceConfigs = {
        ec2: {
            title: 'EC2 Configuration',
            icon: 'EC2',
            fields: [
                { id: 'ec2Tags', label: 'Instance Tags', placeholder: 'Environment=prod,Team=backend', required: true, help: 'Comma-separated key=value pairs' },
                { id: 'ec2Actions', label: 'Actions', placeholder: 'describe,start,stop', required: false, help: 'Specific EC2 actions (optional)' }
            ]
        },
        s3: {
            title: 'S3 Configuration',
            icon: 'S3',
            fields: [
                { id: 's3Bucket', label: 'Bucket Name', placeholder: 'my-app-bucket', required: true, help: 'Exact S3 bucket name' },
                { id: 's3Prefix', label: 'Object Prefix', placeholder: 'logs/', required: false, help: 'Limit access to specific path (optional)' }
            ]
        },
        secretsmanager: {
            title: 'Secrets Manager Configuration',
            icon: 'SM',
            fields: [
                { id: 'secretName', label: 'Secret Name', placeholder: 'MyApp-Database-Password', required: true, help: 'Exact secret name (required for security)' }
            ]
        },
        lambda: {
            title: 'Lambda Configuration',
            icon: 'Œª',
            fields: [
                { id: 'lambdaFunction', label: 'Function Name', placeholder: 'my-function-name', required: true, help: 'Exact Lambda function name' },
                { id: 'lambdaActions', label: 'Actions', placeholder: 'invoke,get', required: false, help: 'Specific Lambda actions (optional)' }
            ]
        },
        rds: {
            title: 'RDS Configuration',
            icon: 'RDS',
            fields: [
                { id: 'rdsInstance', label: 'DB Instance ID', placeholder: 'my-database', required: false, help: 'Specific RDS instance (optional)' }
            ]
        },
        cloudwatch: {
            title: 'CloudWatch Configuration',
            icon: 'CW',
            fields: [
                { id: 'logGroup', label: 'Log Group', placeholder: '/aws/lambda/my-function', required: false, help: 'Specific log group (optional)' }
            ]
        }
    };
    
    // Generate config sections for selected services
    selectedServices.forEach(service => {
        const config = serviceConfigs[service];
        if (!config) return;
        
        const configDiv = document.createElement('div');
        configDiv.className = 'service-config';
        configDiv.innerHTML = `
            <h4>
                <span class="service-icon">${config.icon}</span>
                ${config.title}
            </h4>
            ${config.fields.map(field => `
                <div class="form-group">
                    <label>${field.label} ${field.required ? '<span class="required">*</span>' : ''}</label>
                    <input type="text" id="${field.id}" placeholder="${field.placeholder}" ${field.required ? 'required' : ''}>
                    <small>${field.help}</small>
                </div>
            `).join('')}
        `;
        
        configsContainer.appendChild(configDiv);
    });
    
    // Show/hide the configs container
    configsContainer.style.display = selectedServices.length > 0 ? 'block' : 'none';
}



function detectAnomalousActivity(userEmail, requestData) {
    const anomalies = [];
    
    // Check for unusual time
    const hour = new Date().getHours();
    if (hour < 6 || hour > 22) {
        anomalies.push('Request made outside business hours');
    }
    
    // Check for high-risk permissions
    if (requestData.ai_permissions && requestData.ai_permissions.actions) {
        const sensitiveActions = requestData.ai_permissions.actions.filter(action => 
            action.includes('Admin') || action.includes('Full') || action.includes('*')
        );
        if (sensitiveActions.length > 0) {
            anomalies.push('High-risk permissions requested');
        }
    }
    
    // Check for unusual account access
    const accountName = accounts[requestData.account_id]?.name || '';
    if (accountName.toLowerCase().includes('prod')) {
        anomalies.push('Production account access requested');
    }
    
    // Check for multiple requests in short time
    const recentRequests = requests.filter(r => 
        r.user_email === userEmail && 
        new Date(r.created_at) > new Date(Date.now() - 30 * 60 * 1000)
    );
    if (recentRequests.length > 2) {
        anomalies.push('Multiple requests in 30 minutes');
    }
    
    if (anomalies.length > 0) {
        notifyAdminOfAnomaly(userEmail, anomalies, requestData);
    }
}

function notifyAdminOfAnomaly(userEmail, anomalies, requestData) {
    const alertData = {
        timestamp: new Date().toISOString(),
        user: userEmail,
        anomalies: anomalies,
        request_details: {
            account: accounts[requestData.account_id]?.name,
            justification: requestData.justification,
            ip_address: 'Unknown' // Would be captured from request
        },
        risk_level: anomalies.length > 2 ? 'HIGH' : 'MEDIUM'
    };
    
    // Send to admin (in production, this would be real notification)
    console.warn('üö® SECURITY ALERT:', alertData);
    
    // Store in audit log
    fetch(`${API_BASE}/security/anomaly`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(alertData)
    }).catch(err => console.error('Failed to log anomaly:', err));
}

function calculateRiskScore(permissions, useCase) {
    let risk = 0;
    const highRiskActions = ['Delete', 'Create', 'Admin', 'Terminate', '*'];
    risk += permissions.actions.filter(action => 
        highRiskActions.some(risky => action.includes(risky))
    ).length * 2;
    
    const hour = new Date().getHours();
    if (hour < 9 || hour > 17) risk += 1;
    if (useCase.length < 20) risk += 1;
    if (permissions.actions.length > 10) risk += 1;
    
    return Math.min(risk, 10);
}

async function generateAIPermissions() {
    const useCase = document.getElementById('aiUseCase').value;
    if (!useCase) {
        alert('Please describe what you need to do');
        return;
    }
    
    // Clear previous messages
    const existingMsg = document.getElementById('intentMessage');
    if (existingMsg) existingMsg.remove();
    
    // Backend will handle all validation - just send the request
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    button.disabled = true;
    
    try {
        const response = await fetch(`${API_BASE}/generate-permissions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ use_case: useCase })
        });
        
        const permissions = await response.json();
        
        // Show live preview if available
        if (permissions.grouped_actions || permissions.preview_actions) {
            const preview = document.getElementById('aiPermissionsPreview');
            const content = document.getElementById('aiPermissionsContent');
            const actionsData = permissions.grouped_actions || permissions.preview_actions;
            
            const actionExplanations = {
                'DescribeInstances': 'View instance details',
                'StartInstances': 'Start stopped instances',
                'StopInstances': 'Stop running instances',
                'TerminateInstances': 'Delete instances permanently',
                'CreateImage': 'Create AMI from instance',
                'DescribeImages': 'View AMI details',
                'CreateSnapshot': 'Create EBS snapshot',
                'RunInstances': 'Launch new instances'
            };
            
            let html = '';
            for (const [svc, data] of Object.entries(actionsData)) {
                html += `<div style="margin-bottom:15px;"><strong style="color:var(--primary-color);">${svc.toUpperCase()}</strong><ul style="list-style:none;padding:0;margin:8px 0 0 0;">`;
                data.actions.forEach(a => {
                    const actionName = a.split(':')[1];
                    const explanation = actionExplanations[actionName] || 'AWS action';
                    html += `<li style="padding:6px 0;border-bottom:1px solid var(--border-color);font-size:11px;"><strong>${actionName}</strong><br><span style="color:var(--text-secondary);">${explanation}</span></li>`;
                });
                html += `</ul></div>`;
            }
            content.innerHTML = html;
            preview.style.display = 'block';
        }
        
        if (permissions.error) {
            if (permissions.intent_analysis) {
                showIntentMessage(permissions.intent_analysis, permissions.suggestion);
            } else if (permissions.suggestion === 'use_existing_permission_sets') {
                const useExisting = confirm(permissions.error + '\n\nWould you like to switch to existing permission sets tab?');
                if (useExisting) {
                    switchAccessType('existing');
                }
            } else {
                alert('Error: ' + permissions.error);
            }
            return;
        }
        
        // AI Risk Assessment and Anomaly Detection
        const riskScore = calculateRiskScore(permissions, useCase);
        if (riskScore > 7) {
            alert(`‚ö†Ô∏è AI Risk Assessment: HIGH RISK (${riskScore}/10)\n\nThis request requires manual review and approval.`);
            // Trigger anomaly detection
            detectAnomalousActivity(localStorage.getItem('userEmail'), {
                ai_permissions: permissions,
                account_id: document.getElementById('requestAccount').value,
                justification: useCase
            });
        } else if (riskScore > 4) {
            alert(`‚ö†Ô∏è AI Risk Assessment: MEDIUM RISK (${riskScore}/10)\n\nPlease ensure your justification is detailed.`);
        }
        
        // Backend handles all permission validation via toggles - no frontend blocking
        
        // Auto-select services based on detected permissions
        const servicesSelect = document.getElementById('awsServices');
        if (servicesSelect && permissions.actions) {
            const autoServices = [];
            
            if (permissions.actions.some(action => action.includes('ec2:') || action.includes('ssm:'))) {
                autoServices.push('ec2');
            }
            if (permissions.actions.some(action => action.includes('s3:'))) {
                autoServices.push('s3');
            }
            if (permissions.actions.some(action => action.includes('lambda:'))) {
                autoServices.push('lambda');
            }
            if (permissions.actions.some(action => action.includes('rds:'))) {
                autoServices.push('rds');
            }
            if (permissions.actions.some(action => action.includes('logs:'))) {
                autoServices.push('cloudwatch');
            }
            if (permissions.actions.some(action => action.includes('secretsmanager:'))) {
                autoServices.push('secretsmanager');
            }
            
            if (autoServices.length > 0) {
                Array.from(servicesSelect.options).forEach(option => {
                    option.selected = autoServices.includes(option.value);
                });
                updateServiceConfigs();
                
                setTimeout(() => {
                    alert(`üí° Detected services: ${autoServices.join(', ')}\n\nPlease configure the services below with specific resource details.`);
                }, 500);
            }
        }
        
        // Display permissions
        const preview = document.getElementById('aiPermissionsPreview');
        const content = document.getElementById('aiPermissionsContent');
        
        // Handle grouped actions (separate statements per service)
        if (permissions.grouped_actions) {
            let statementsHtml = '<p><strong>Description:</strong> ' + permissions.description + '</p>';
            statementsHtml += '<p><strong>Policy Statements (Separate SID per service):</strong></p>';
            
            for (const [service, data] of Object.entries(permissions.grouped_actions)) {
                statementsHtml += `<div style="margin: 10px 0; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">`;
                statementsHtml += `<strong>üì¶ ${service.toUpperCase()}</strong><ul>`;
                data.actions.forEach(action => {
                    statementsHtml += `<li class="permission-item">${action}</li>`;
                });
                statementsHtml += `</ul><small>Resources: ${JSON.stringify(data.resources)}</small></div>`;
            }
            content.innerHTML = statementsHtml;
        } else {
            content.innerHTML = `
                <p><strong>Description:</strong> ${permissions.description}</p>
                <p><strong>Actions:</strong></p>
                <ul>
                    ${permissions.actions.map(action => `<li class="permission-item">${action}</li>`).join('')}
                </ul>
                <p><strong>Resources:</strong> ${JSON.stringify(permissions.resources)}</p>
            `;
        }
        
        preview.style.display = 'block';
        
        // Store permissions for form submission
        window.currentAIPermissions = permissions;
        
        // Log AI usage for security monitoring
        fetch(`${API_BASE}/security/ai-usage`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user_email: localStorage.getItem('userEmail'),
                use_case: useCase,
                generated_actions: permissions.actions,
                timestamp: new Date().toISOString(),
                risk_score: riskScore
            })
        }).catch(err => console.error('Failed to log AI usage:', err));
        
    } catch (error) {
        console.error('Error generating permissions:', error);
        alert('Error generating permissions. Please try again.');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

async function handleNewRequest(e) {
    e.preventDefault();
    console.log('Form submitted');
    console.log('window.currentAIPermissions at submit:', window.currentAIPermissions);
    
    // Check if user is logged in
    const userEmail = localStorage.getItem('userEmail');
    if (!userEmail) {
        alert('Please login first');
        return;
    }
    
    const durationValue = document.getElementById('requestDuration').value;
    let durationHours;
    let customDates = null;
    
    if (durationValue === 'custom' && window.customDuration) {
        durationHours = window.customDuration.hours;
        customDates = {
            start: window.customDuration.startDate,
            end: window.customDuration.endDate
        };
    } else {
        durationHours = parseInt(durationValue);
    }
    
    const formData = {
        user_email: userEmail,
        account_id: document.getElementById('requestAccount').value,
        duration_hours: durationHours,
        justification: document.getElementById('requestJustification').value
    };
    
    if (customDates) {
        formData.custom_start_date = customDates.start;
        formData.custom_end_date = customDates.end;
    }
    
    console.log('Form data:', formData);
    
    // Validate required fields
    if (!formData.account_id) {
        alert('Please select an account');
        return;
    }
    
    if (!formData.justification) {
        alert('Please provide business justification');
        return;
    }
    
    // Check if AI permissions were generated
    console.log('=== SUBMIT DEBUG ===');
    console.log('window.currentAIPermissions:', window.currentAIPermissions);
    console.log('Type:', typeof window.currentAIPermissions);
    console.log('Has grouped_actions?', window.currentAIPermissions?.grouped_actions);
    console.log('grouped_actions value:', window.currentAIPermissions?.grouped_actions);
    console.log('===================');
    if (window.currentAIPermissions && window.currentAIPermissions.grouped_actions) {
        console.log('‚úÖ AI permissions found');
        
        formData.use_case = window.currentAIPermissions.description || 'AI-generated access request';
        formData.ai_generated = true;
        formData.is_jit = true;
        formData.ai_permissions = {
            grouped_actions: window.currentAIPermissions.grouped_actions,
            description: window.currentAIPermissions.description
        };
        
        // Services already set from grouped_actions above
        
        // Service configs already handled above
        
    } else {
        console.error('‚ùå No AI permissions found');
        console.log('window.currentAIPermissions:', window.currentAIPermissions);
        alert('Please chat with AI Copilot to generate permissions first');
        return;
    }
    
    console.log('Final form data:', formData);
    
    try {
        const response = await fetch(`${API_BASE}/request-access`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.error) {
            alert('Error: ' + result.error);
            return;
        }
        
        alert(`‚úÖ Request submitted successfully!\n\nRequest ID: ${result.request_id}\n\nYour request is now pending approval.`);
        
        cancelNewRequest();
        
        // Refresh data
        await loadRequests();
        updateDashboard();
        
    } catch (error) {
        console.error('Error submitting request:', error);
        alert('Error submitting request. Please try again.');
    }
}

// Debug Functions
async function testConnection() {
    try {
        console.log('Testing connection to backend...');
        const response = await fetch(`${API_BASE}/accounts`);
        const data = await response.json();
        console.log('Backend response:', data);
        alert(`‚úÖ Backend connection successful!\n\nFound ${Object.keys(data).length} accounts`);
    } catch (error) {
        console.error('Backend connection failed:', error);
        alert(`‚ùå Backend connection failed:\n\n${error.message}`);
    }
}

// Admin Functions
function loadAdminPage() {
    loadAdminDashboard();
}

function loadAdminDashboard() {
    updateAdminDashboard();
    setTimeout(loadCharts, 500);
}

function loadUsersManagement() {
    loadUsersTable();
}

function loadAuditLogs() {
    loadAuditLogsTable();
}

function updateAdminDashboard() {
    const allUsers = new Set(requests.map(r => r.user_email));
    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
    
    // New users (first request in last 30 days)
    const newUsers = new Set();
    const userFirstRequest = {};
    
    requests.forEach(r => {
        const requestDate = new Date(r.created_at);
        if (!userFirstRequest[r.user_email] || requestDate < new Date(userFirstRequest[r.user_email])) {
            userFirstRequest[r.user_email] = r.created_at;
        }
    });
    
    Object.entries(userFirstRequest).forEach(([email, firstDate]) => {
        if (new Date(firstDate) >= thirtyDaysAgo) {
            newUsers.add(email);
        }
    });
    
    // Repeated users (more than 3 requests)
    const userRequestCounts = {};
    requests.forEach(r => {
        userRequestCounts[r.user_email] = (userRequestCounts[r.user_email] || 0) + 1;
    });
    const repeatedUsers = Object.values(userRequestCounts).filter(count => count > 3).length;
    
    // Exceptional users (admin permissions or high-risk access)
    const exceptionalUsers = new Set();
    requests.forEach(r => {
        if (r.permission_set && r.permission_set.includes('Admin')) {
            exceptionalUsers.add(r.user_email);
        }
    });
    
    const pendingApprovals = requests.filter(r => r.status === 'pending').length;
    
    const newUsersEl = document.getElementById('newUsersCount');
    const repeatedUsersEl = document.getElementById('repeatedUsersCount');
    const exceptionalUsersEl = document.getElementById('exceptionalUsersCount');
    const pendingApprovalsEl = document.getElementById('pendingApprovalsCount');
    
    if (newUsersEl) newUsersEl.textContent = newUsers.size;
    if (repeatedUsersEl) repeatedUsersEl.textContent = repeatedUsers;
    if (exceptionalUsersEl) exceptionalUsersEl.textContent = exceptionalUsers.size;
    if (pendingApprovalsEl) pendingApprovalsEl.textContent = pendingApprovals;
}

function loadCharts() {
    loadUserActivityChart();
    loadRequestTypesChart();
}

function loadUserActivityChart() {
    const ctx = document.getElementById('userActivityChart');
    if (!ctx) return;
    
    const data = {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [{
            label: 'Requests',
            data: [12, 19, 8, 15, 22, 3, 7],
            borderColor: '#FF6B9D',
            backgroundColor: 'rgba(255, 107, 157, 0.1)',
            tension: 0.4
        }]
    };
    
    new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
}

function loadRequestTypesChart() {
    const ctx = document.getElementById('requestTypesChart');
    if (!ctx) return;
    
    const data = {
        labels: ['AWS', 'Applications', 'Databases', 'Kubernetes'],
        datasets: [{
            data: [45, 25, 20, 10],
            backgroundColor: ['#FF6B9D', '#4A90E2', '#28a745', '#ffc107']
        }]
    };
    
    new Chart(ctx, {
        type: 'doughnut',
        data: data,
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } }
        }
    });
}

function loadUsersTable() {
    const tbody = document.getElementById('usersTableBody');
    if (!tbody) return;
    
    const users = [
        {
            email: 'satish.korra@nykaa.com',
            source: 'Google Workspace',
            status: 'Active',
            mfa: true,
            lastLogin: '2024-01-15 10:30',
            requestCount: 5
        }
    ];
    
    tbody.innerHTML = users.map(user => `
        <tr>
            <td>${user.email}</td>
            <td>${user.source}</td>
            <td><span class="status-badge status-approved">${user.status}</span></td>
            <td>${user.mfa ? '‚úÖ Enabled' : '‚ùå Disabled'}</td>
            <td>${user.lastLogin}</td>
            <td>${user.requestCount}</td>
            <td>
                <button class="btn-secondary" onclick="editUser('${user.email}')">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function loadAuditLogsTable() {
    const tbody = document.getElementById('auditLogsTableBody');
    if (!tbody) return;
    
    const auditLogs = [
        {
            timestamp: '2024-01-15 10:30:15',
            user: 'satish.korra@nykaa.com',
            event: 'Access Request',
            resource: 'AWS Account',
            ip: '192.168.1.100',
            status: 'Success'
        }
    ];
    
    tbody.innerHTML = auditLogs.map(log => `
        <tr>
            <td>${log.timestamp}</td>
            <td>${log.user}</td>
            <td>${log.event}</td>
            <td>${log.resource}</td>
            <td>${log.ip}</td>
            <td><span class="status-badge status-approved">${log.status}</span></td>
        </tr>
    `).join('');
}

// User Management Functions
function syncUsers() {
    alert('üîÑ Syncing users from identity providers...');
}

function editUser(email) {
    alert(`Edit user: ${email}`);
}

function generateTempPassword() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
    let password = '';
    for (let i = 0; i < 12; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    document.getElementById('onboardPassword').value = password;
}

// Integration Functions
function showCloudOnboarding() {
    showModal('cloudOnboardingModal');
}

function onboardCloud(provider) {
    closeModal();
    alert(`${provider.toUpperCase()} onboarding will be available soon.\n\nYou'll be able to connect your ${provider.toUpperCase()} accounts and sync them automatically.`);
}

function showIntegrationTab(tabName) {
    document.querySelectorAll('.integration-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.integration-tab-content').forEach(content => content.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tabName + 'IntegrationTab').classList.add('active');
}

function showIntentMessage(intentAnalysis, suggestion) {
    const aiCopilotTab = document.getElementById('aiCopilotTab');
    const useCaseTextarea = document.getElementById('aiUseCase');
    
    let messageHtml = '';
    
    if (suggestion === 'create_jira_ticket') {
        messageHtml = `
            <div id="intentMessage" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; margin: 1rem 0; border-radius: 4px;">
                <div style="display: flex; align-items: start; gap: 0.5rem;">
                    <i class="fas fa-exclamation-triangle" style="color: #856404; margin-top: 2px;"></i>
                    <div style="color: #856404; font-size: 0.9rem;">
                        <strong>Infrastructure Request Detected</strong><br>
                        This system provides temporary ACCESS to existing resources only.<br>
                        For new resource creation, please create a JIRA ticket for DevOps/Platform team.<br><br>
                        <strong>Detected:</strong> ${intentAnalysis.intents.join(', ')} - ${intentAnalysis.resources.join(', ')}<br><br>
                        <strong>To request access:</strong> Specify existing resource name (e.g., "access bucket: my-existing-bucket")
                    </div>
                </div>
            </div>
        `;
    } else if (suggestion === 'manager_approval_required') {
        messageHtml = `
            <div id="intentMessage" style="background: #f8d7da; border-left: 4px solid #dc3545; padding: 1rem; margin: 1rem 0; border-radius: 4px;">
                <div style="display: flex; align-items: start; gap: 0.5rem;">
                    <i class="fas fa-ban" style="color: #721c24; margin-top: 2px;"></i>
                    <div style="color: #721c24; font-size: 0.9rem;">
                        <strong>Destructive Operation Detected</strong><br>
                        DELETE/CLEANUP operations require manager approval and proper justification.<br><br>
                        <strong>Detected:</strong> ${intentAnalysis.intents.join(', ')}<br><br>
                        <strong>Alternative:</strong> Request READ-ONLY access first to review data
                    </div>
                </div>
            </div>
        `;
    }
    
    useCaseTextarea.insertAdjacentHTML('afterend', messageHtml);
}

function configureIntegration(provider) {
    alert(`Configure ${provider} integration`);
}

function filterAuditLogs() {
    alert('Filter audit logs');
}

function loadRequestForOthersModalData() {
    // Load accounts
    const accountSelect = document.getElementById('otherRequestAccount');
    if (accountSelect) {
        accountSelect.innerHTML = '<option value="">Select Account</option>' +
            Object.values(accounts).map(account => 
                `<option value="${account.id}">${account.name} (${account.id})</option>`
            ).join('');
    }
    
    // Load permission sets
    const permissionSetSelect = document.getElementById('otherRequestPermissionSet');
    if (permissionSetSelect) {
        permissionSetSelect.innerHTML = '<option value="">Select Permission Set</option>' +
            permissionSets.map(ps => 
                `<option value="${ps.arn}">${ps.name}</option>`
            ).join('');
    }
    
    // Setup email tags functionality
    setupEmailTags();
}

let selectedEmails = [];

function setupEmailTags() {
    const emailInput = document.getElementById('requesterEmail');
    const emailTags = document.getElementById('emailTags');
    
    if (!emailInput || !emailTags) return;
    
    emailInput.addEventListener('keydown', function(e) {
        if (e.key === 'Tab' || e.key === 'Enter') {
            e.preventDefault();
            addEmailTag(this.value.trim());
            this.value = '';
        } else if (e.key === 'Backspace' && this.value === '' && selectedEmails.length > 0) {
            removeEmailTag(selectedEmails.length - 1);
        }
    });
    
    emailInput.addEventListener('blur', function() {
        if (this.value.trim()) {
            addEmailTag(this.value.trim());
            this.value = '';
        }
    });
}

function addEmailTag(email) {
    if (!email || !isValidEmail(email) || selectedEmails.includes(email)) {
        return;
    }
    
    selectedEmails.push(email);
    renderEmailTags();
}

function removeEmailTag(index) {
    selectedEmails.splice(index, 1);
    renderEmailTags();
}

function renderEmailTags() {
    const emailTags = document.getElementById('emailTags');
    if (!emailTags) return;
    
    emailTags.innerHTML = selectedEmails.map((email, index) => `
        <span class="email-tag">
            ${email}
            <button type="button" class="email-tag-remove" onclick="removeEmailTag(${index})">&times;</button>
        </span>
    `).join('');
}

function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

function switchOtherAccessType(type) {
    // Update tab buttons
    document.querySelectorAll('#requestForOthersModal .tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Update tab content
    document.querySelectorAll('#requestForOthersModal .tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById(type === 'existing' ? 'otherExistingPermissionsTab' : 'otherAiCopilotTab').classList.add('active');
}

let otherCurrentAIPermissions = null;

async function generateOtherAIPermissions() {
    const useCase = document.getElementById('otherAiUseCase').value;
    if (!useCase) {
        alert('Please describe what users need to do');
        return;
    }
    
    // Simple validation - AI only responds to AWS access requests
    const useCaseLower = useCase.toLowerCase();
    
    // Check if request contains AWS services or access keywords
    const awsKeywords = ['aws', 'ec2', 's3', 'lambda', 'iam', 'cloudformation', 'rds', 'dynamodb', 'vpc', 'cloudwatch', 'access', 'permission'];
    const hasAwsContext = awsKeywords.some(keyword => useCaseLower.includes(keyword));
    
    if (!hasAwsContext) {
        alert('AI only generates AWS access permissions. Please specify your AWS access requirements.');
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    button.disabled = true;
    
    try {
        const response = await fetch(`${API_BASE}/generate-permissions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ use_case: useCase })
        });
        
        const permissions = await response.json();
        
        if (permissions.error) {
            alert('Error: ' + permissions.error);
            return;
        }
        
        // Display permissions
        const preview = document.getElementById('otherAiPermissionsPreview');
        const content = document.getElementById('otherAiPermissionsContent');
        
        content.innerHTML = `
            <p><strong>Description:</strong> ${permissions.description}</p>
            <p><strong>Actions:</strong></p>
            <ul>
                ${permissions.actions.map(action => `<li class="permission-item">${action}</li>`).join('')}
            </ul>
            <p><strong>Resources:</strong> ${JSON.stringify(permissions.resources)}</p>
        `;
        
        preview.style.display = 'block';
        
        // Store permissions for form submission
        otherCurrentAIPermissions = permissions;
        
    } catch (error) {
        console.error('Error generating permissions:', error);
        alert('Error generating permissions. Please try again.');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Form Handlers
async function handleRequestForOthers(e) {
    e.preventDefault();
    
    // Add current input value to emails if any
    const currentInput = document.getElementById('requesterEmail').value.trim();
    if (currentInput && isValidEmail(currentInput) && !selectedEmails.includes(currentInput)) {
        selectedEmails.push(currentInput);
    }
    
    if (selectedEmails.length === 0) {
        alert('Please add at least one email address');
        return;
    }
    
    const account_id = document.getElementById('otherRequestAccount').value;
    const duration_hours = parseInt(document.getElementById('otherRequestDuration').value);
    const justification = document.getElementById('otherRequestJustification').value;
    
    // Check if AI or existing permission set
    const activeTab = document.querySelector('#requestForOthersModal .tab-btn.active').textContent;
    let permission_set = null;
    let use_case = null;
    
    if (activeTab.includes('AI')) {
        if (!otherCurrentAIPermissions) {
            alert('Please generate permissions first');
            return;
        }
        use_case = document.getElementById('otherAiUseCase').value;
    } else {
        permission_set = document.getElementById('otherRequestPermissionSet').value;
        if (!permission_set) {
            alert('Please select a permission set');
            return;
        }
    }
    
    // Validate required fields
    if (!account_id || !justification) {
        alert('Please fill in all required fields');
        return;
    }
    
    try {
        const results = [];
        
        // Submit request for each email
        for (const email of selectedEmails) {
            const formData = {
                user_email: email,
                account_id: account_id,
                duration_hours: duration_hours,
                justification: justification,
                requested_by: localStorage.getItem('userEmail')
            };
            
            // Add AI or existing permission set data
            if (use_case) {
                formData.use_case = use_case;
                formData.ai_generated = true;
            } else {
                formData.permission_set = permission_set;
                formData.ai_generated = false;
            }
            
            const response = await fetch(`${API_BASE}/request-for-others`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            results.push({ email, result });
        }
        
        // Show results
        const successful = results.filter(r => !r.result.error);
        const failed = results.filter(r => r.result.error);
        
        let message = `‚úÖ Requests submitted for ${successful.length} user(s):\n`;
        successful.forEach(r => {
            message += `‚Ä¢ ${r.email}: ${r.result.request_id}\n`;
        });
        
        if (failed.length > 0) {
            message += `\n‚ùå Failed for ${failed.length} user(s):\n`;
            failed.forEach(r => {
                message += `‚Ä¢ ${r.email}: ${r.result.error}\n`;
            });
        }
        
        alert(message);
        closeRequestForOthersModal();
        
        // Refresh data
        await loadRequests();
        updateDashboard();
        
        // Clear form
        document.getElementById('requestForOthersForm').reset();
        selectedEmails = [];
        renderEmailTags();
        otherCurrentAIPermissions = null;
        document.getElementById('otherAiPermissionsPreview').style.display = 'none';
        
    } catch (error) {
        console.error('Error submitting request:', error);
        alert('Error submitting request. Please try again.');
    }
}

function handleManualOnboard(e) {
    e.preventDefault();
    alert('Manual onboarding initiated');
    closeModal();
}

function handleAppRequest(e) {
    e.preventDefault();
    alert('Application access request submitted');
    closeModal();
}

function updateSpecificAppOptions() {
    const appType = document.getElementById('appType').value;
    const specificAppSelect = document.getElementById('specificApp');
    
    const appOptions = {
        cloud: [
            { value: 'aws', text: 'Amazon Web Services' },
            { value: 'azure', text: 'Microsoft Azure' },
            { value: 'gcp', text: 'Google Cloud Platform' }
        ],
        kubernetes: [
            { value: 'eks', text: 'Amazon EKS' },
            { value: 'aks', text: 'Azure AKS' },
            { value: 'gke', text: 'Google GKE' }
        ],
        database: [
            { value: 'mysql', text: 'MySQL' },
            { value: 'postgres', text: 'PostgreSQL' },
            { value: 'mongodb', text: 'MongoDB' },
            { value: 'rds', text: 'Amazon RDS' }
        ],
        application: [
            { value: 'jenkins', text: 'Jenkins' },
            { value: 'grafana', text: 'Grafana' },
            { value: 'sonar', text: 'SonarQube' }
        ],
        ticketing: [
            { value: 'jira', text: 'JIRA' },
            { value: 'splunk', text: 'Splunk' },
            { value: 'servicenow', text: 'ServiceNow' }
        ]
    };
    
    specificAppSelect.innerHTML = '<option value="">Select Application</option>';
    
    if (appOptions[appType]) {
        specificAppSelect.innerHTML += appOptions[appType]
            .map(app => `<option value="${app.value}">${app.text}</option>`)
            .join('');
    }
}

function exportAuditLog() {
    const auditData = requests.map(r => ({
        request_id: r.id,
        user_email: r.user_email,
        account_id: r.account_id,
        status: r.status,
        created_at: r.created_at,
        expires_at: r.expires_at,
        justification: r.justification
    }));
    
    const blob = new Blob([JSON.stringify(auditData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `jit-audit-log-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function cleanupOldRequests() {
    if (!confirm('üßπ This will delete all requests older than 3 days with inactive status.\n\nContinue?')) {
        return;
    }
    
    fetch(`${API_BASE}/cleanup/old-requests`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(result => {
        alert(`‚úÖ ${result.message}`);
        loadRequests();
        updateDashboard();
        if (isAdmin) updateAdminDashboard();
    })
    .catch(error => {
        console.error('Error cleaning up requests:', error);
        alert('‚ùå Error cleaning up requests');
    });
}

function revokeAllExpired() {
    if (!confirm('‚ö†Ô∏è This will revoke ALL expired access grants immediately.\n\nContinue?')) {
        return;
    }
    
    fetch(`${API_BASE}/cleanup/expired`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(result => {
        alert(`‚úÖ ${result.message}`);
        loadRequests();
        updateDashboard();
        if (isAdmin) updateAdminDashboard();
    })
    .catch(error => {
        console.error('Error revoking expired access:', error);
        alert('‚ùå Error revoking expired access');
    });
}

function refreshRequests() {
    location.reload();
}

// Request Dropdown Toggle
function toggleRequestDropdown() {
    const menu = document.getElementById('requestDropdownMenu');
    menu.classList.toggle('show');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    const dropdown = document.querySelector('.request-dropdown');
    if (dropdown && !dropdown.contains(e.target)) {
        const menu = document.getElementById('requestDropdownMenu');
        if (menu) menu.classList.remove('show');
    }
});

// OTP Input Auto-Focus
function setupOTPInputs() {
    const otpInputs = document.querySelectorAll('.otp-input');
    otpInputs.forEach((input, index) => {
        input.addEventListener('input', function() {
            if (this.value.length === 1 && index < otpInputs.length - 1) {
                otpInputs[index + 1].focus();
            }
        });
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && this.value === '' && index > 0) {
                otpInputs[index - 1].focus();
            }
        });
    });
}

// Utility Functions
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}